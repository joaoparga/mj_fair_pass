---
title: "Mobilizing Justice: Montreal Fair Pass Pilot"
author:
  - name: Jo√£o Pedro Figueira Amorim Parga
    orcid: 0000-0002-4105-5927
    email: joao.parga@mail.utoronto.ca
    affiliations:
      - name: Mobilizing Justice Partnership
format:
  docx: 
    reference-doc: custom-reference-doc.docx
    toc: false
    toc-depth: 2
    number-sections: true
  html:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    code_folding: hide
    theme: readable
    embed-resources: true
  pdf:
    fig-width: 6
    fig-asp: 0.618
    number-sections: true
    colorlinks: true
    keeptex: true
    include-in-header: 
      text: |
        \usepackage{booktabs}
        \usepackage{siunitx}
        \newcolumntype{d}{S[
            input-open-uncertainty=,
            input-close-uncertainty=,
            parse-numbers = false,
            table-align-text-pre=false,
            table-align-text-post=false
         ]}
date: "last-modified"
date-format: '[This version:] MMMM D, YYYY'
abstract: "This report overviews the first wave of the Montreal Fair Pass Survey's data. The survey's spatial representation generally coincides with areas that concentrate populations from low-income groups. Individuals from low-income households appear to be over-represented in the survey as a whole (13 p.p. difference from the census data), Visible minorities, on the other hand, appear to be under-represented (29 p.p. difference). Other groups, such as women and man, and control (50 to 64 years old) and treatment (above 65 years old), showed no significant difference in representation. The code used to produce this report is found on the project's [github repository](https://github.com/joaoparga/mj_fair_pass). "
bibliography: bib/zoterolibrary_updated_10_05_23.bib
csl: csl/american-sociological-association.csl
tbl-cap-location: top
number-sections: true
execute:
  echo: false
  warning: false
  message: false
  cache: false
editor:
  mode: source
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE)
# Use cache = TRUE if you want to speed up compilation

knitr::opts_knit$set(output.format = "html")  # Set to "html" for HTML output

# A function to allow for showing some of the inline code
rinline <- function(code){
  html <- '<code  class="r">``` `r CODE` ```</code>'
  sub("CODE", code, html)
}
```

```{r packages}
#| echo: false
#| include: false
library(tidyverse)
library(sf)
library(data.table)
library(janitor)
library(fs)
library(cancensus)
library(tmap)
library(DataExplorer)
library(patchwork)
library(mapview)
library(modelsummary)
library(kableExtra)
library(knitr)
library(gt)
library(conflicted)
library(stars)
library(showtext)
library(sysfonts)
library(hrbrthemes)
```

```{r conflicts}
#| include: false
select <- dplyr::select
conflicted::conflicts_prefer(dplyr::filter)
```

```{r fonts}
#| include: false
#| # use different fonts
sysfonts::font_add_google("Roboto", "roboto")
showtext::showtext_auto()
```


<!-- READ AND MANIPULATE DATA -->

```{r readdata}
#| include: false
# montreal fsa
montreal_fsa <- sf::st_read("data/report/montreal_fsa_count.gpkg")
# montreal cd (ct)
montreal_cd_ct <- sf::st_read("data/report/montreal_cd_ct_count.gpkg")
# survey raw data
n_obs_survey_raw <- data.table::fread("data/utscfiletransfer/Montreal_Corrected_Geocoding_2023_09_18.csv") %>% 
  nrow()
# survey geocoded
n_obs_survey_geocoded <- 
  sf::st_read("data/df_survey_montreal_filter_sf_new.gpkg") %>% 
  nrow()
# survey filtered data
survey_filter_cd <- sf::st_read("data/report/survey_filter_inside_cd.gpkg")
```




<!-- START OF THE DOCUMENT -->

# Initial information

The original raw dataset contained `r n_obs_survey_raw` respondents, of which we were able to geocode `r n_obs_survey_geocoded` observations.
`r n_obs_survey_geocoded - nrow(survey_filter_cd)` of them declared their residential location outside a 250 meter buffer around the island of Montreal (Census Division code equals to 2466), leaving us with `r nrow(survey_filter_cd)` respondents within the borders of the island and, therefore, in the final dataset.

# Survey's representation {#sec-spatial}

```{r aggregateresultsfsa}
#| include: false
fsa <- montreal_fsa %>% 
  select(geouid) %>% 
  rename("fsa_geouid" = "geouid")
ct <- montreal_cd_ct %>% 
  select(geo_uid, count_lim_tot_parent, count_lim_tot_in_lim) %>% 
  rename("ct_geo_uid" = "geo_uid")

fsa_ct_join <- sf::st_join(fsa, ct)

total_lim_sum <- sum(montreal_cd_ct$count_lim_tot_parent)

fsa_ct_grouped <- fsa_ct_join %>% 
  group_by(fsa_geouid) %>% 
  summarise(
    sum_lim_tot_parent = sum(count_lim_tot_parent, na.rm = T)
    , sum_lim_tot_in_lim = sum(count_lim_tot_in_lim, na.rm = T)
    , prop_tot_pop = sum_lim_tot_parent / total_lim_sum
    , prop_tot_in_lim = sum_lim_tot_in_lim / total_lim_sum
  )
```

## Demographics 

The plot below shows comparisons of the survey's representation according to selected demographics.
Categories where the [red dot]{style="color: red;"} is on the right mean under-representation of the survey (i.e., the census' relative population of a given group is greater than the survey's), while categories where the blue dot is on the right equal over-representation of the survey (i.e., the survey's relative population of a given group is greater than the census').
The survey, then, over-represents for women, the control group (50-64 years old), and people within the Low-income measure, and under-representation occurs for men, the treatment group (65 years or older), and visible minorities.

Differences in representation appear to be insignificant for the most groups, with the notable exception of Low-income and Visible Minorities.
The former has a 13 p.p. over-representation, while the latter is under represented by 29 p.p..
These differences put into question MJ's capacity to assess the policy's effectiveness for visible minorities, given their under-representation on the survey.
This is an unfortunate situation, considering those are historically and structurally marginalized groups that suffer disproportionately with transport poverty and transport-related social exclusion, and that these groups would be target audiences for a policy that reduces the monetary burden of transportation such as the fare-free pass program.


```{r createcomptable}
#| include: false
obssurvey <- survey_filter_cd %>% nrow()

census_age_sums <- montreal_cd_ct %>% 
  st_drop_geometry() %>% 
  select(matches("^age_(50_over|50_64|65_over)")) %>% 
  summarise(across(everything(), ~ sum(., na.rm = T)))
  

df_representation <- tibble(
  prop_lim_census = sum(montreal_cd_ct$count_lim_tot_in_lim, na.rm = T) /
    sum(montreal_cd_ct$count_lim_tot_parent, na.rm = T)
  , prop_lim_survey = survey_filter_cd %>% filter(in_lim=="Yes") %>% nrow() /
    obssurvey
  , prop_vis_minority_census = sum(montreal_cd_ct$tot_vis_minority_tot, na.rm = T) /
    sum(montreal_cd_ct$tot_vis_minority_tot_parent, na.rm = T)
  , prop_vis_minority_survey = survey_filter_cd %>% filter(visible_minority=="Visible minority") %>% nrow() /
    obssurvey
  , prop_male_census = sum(montreal_cd_ct$male_tot, na.rm = T) / sum(montreal_cd_ct$total_tot, na.rm = T)
  , prop_male_survey = survey_filter_cd %>% filter(gender=="male") %>% nrow() / obssurvey
  , prop_female_census = sum(montreal_cd_ct$female_tot, na.rm = T) / sum(montreal_cd_ct$total_tot, na.rm = T)
  , prop_female_survey = survey_filter_cd %>% filter(gender=="female") %>% nrow() / obssurvey
  , prop_age_50_64_tot_census = census_age_sums$age_50_64_tot / census_age_sums$age_50_over_tot
  , prop_age_50_64_tot_survey = survey_filter_cd %>% filter(age_groups_control_treat=="Control (50-64)") %>% nrow() / obssurvey
  , prop_age_50_64_mal_census = census_age_sums$age_50_64_mal / census_age_sums$age_50_over_mal
  , prop_age_50_64_mal_survey = survey_filter_cd %>% filter(age_groups_control_treat=="Control (50-64)" & gender=="male") %>% nrow() / survey_filter_cd %>% filter(gender=="male") %>% nrow()
  , prop_age_50_64_fem_census = census_age_sums$age_50_64_fem / census_age_sums$age_50_over_fem
  , prop_age_50_64_fem_survey = survey_filter_cd %>% filter(age_groups_control_treat=="Control (50-64)" & gender=="female") %>% nrow() / survey_filter_cd %>% filter(gender=="female") %>% nrow()
  , prop_age_65_over_tot_census = census_age_sums$age_65_over_tot / census_age_sums$age_50_over_tot
  , prop_age_65_over_tot_survey = survey_filter_cd %>% filter(age_groups_control_treat=="Treatment (65-over)") %>% nrow() / obssurvey
  , prop_age_65_over_mal_census = census_age_sums$age_65_over_mal / census_age_sums$age_50_over_mal
  , prop_age_65_over_mal_survey = survey_filter_cd %>% filter(age_groups_control_treat=="Treatment (65-over)" & gender=="male") %>% nrow() / survey_filter_cd %>% filter(gender=="male") %>% nrow()
  , prop_age_65_over_fem_census = census_age_sums$age_65_over_fem / census_age_sums$age_50_over_fem
  , prop_age_65_over_fem_survey = survey_filter_cd %>% filter(age_groups_control_treat=="Treatment (65-over)" & gender=="female") %>% nrow() / survey_filter_cd %>% filter(gender=="female") %>% nrow()
  
  # , prop_age_65_over_tot_census = census_age_sums$age_65_over_tot / census_age_sums$age_50_over_tot
  # , prop_age_65_over_tot__survey = survey_filter_cd %>% filter(age_groups_control_treat=="Treatment (65-over)") %>% nrow() / obssurvey
) %>% 
  map_df(~round(., 2))

df_representation_t <- df_representation %>%
  pivot_longer(everything()) %>% 
  separate_wider_regex(
    cols = name
    , c("prop_", Category = ".*", "_", Source = "(?:census|survey)")
  ) %>% 
  rename(Proportion = value) %>% 
  mutate(
    Category = case_when(
      Category == "lim" ~ "In LIM"
      , Category == "vis_minority" ~ "Visible Minority"
      , Category == "male" ~ "Gender: Male"
      , Category == "female" ~ "Gender: Female"
      , Category == "age_50_64_tot" ~ "Age 50-64 (Total)"
      , Category == "age_50_64_mal" ~ "Age 50-64 (Male)"
      , Category == "age_50_64_fem" ~ "Age 50-64 (Female)"
      , Category == "age_65_over_tot" ~ "Age 65+ (Total)"
      , Category == "age_65_over_mal" ~ "Age 65+ (Male)"
      , Category == "age_65_over_fem" ~ "Age 65+ (Female)"
      , .default = "error"
    )
    , Source = case_when(
      Source == "census" ~ "Census"
      , .default = "Survey"
    )
  ) %>% 
  arrange(Proportion, Source) %>% 
  mutate(Category = as_factor(Category))

```

```{r, fig.align="center", fig.pos="H", fig.cap="Proportion of respondents by Source and Demographics"}
#| echo: false
#| label: fig-1-demographics-census-survey
#| out-width: 100%
#| fig-format: pdf
#| fig-asp: 0.7
#| fig-width: 7
df_right_label <- df_representation_t %>% 
  group_by(Category) %>% 
  arrange(desc(Proportion)) %>% 
  top_n(1) %>% 
  mutate(pct = scales::percent(Proportion))

df_left_label <- df_representation_t %>% 
  group_by(Category) %>% 
  arrange(desc(Proportion)) %>% 
  slice(2) %>% 
  mutate(pct = scales::percent(Proportion))

df_representation_t %>% 
  mutate(Category = factor(Category, levels = rev(df_right_label$Category))) %>% 
  # arrange(Proportion, Source) %>% 
  # mutate(Category = factor(Category)) 
# %>% 
  ggplot(aes(x = Proportion, y = Category)) +
  geom_line(aes(group = Category), colour = "darkgrey") +
  geom_point(aes(color = Source), size = 3) +
  geom_text(
    data = df_right_label
    , aes(color = Source, label = pct)
    , size = 3
    , hjust = -0.5
  ) +
  geom_text(
    data = df_left_label
    , aes(color = Source, label = pct)
    , size = 3
    , hjust = +1.5
  ) +
  scale_x_continuous(
    labels = scales::percent
    , expand = expansion(mult = c(0.1, 0.1))
    ) +
  labs(
    # title = "Proportion of respondents by Source and Demographics"
    , y = "Demographics"
  ) +
  scale_colour_manual(values = c("Census" = "#ca0020", "Survey" = "#0571b0")) +
  hrbrthemes::theme_ipsum(base_family = "roboto") +
  theme(
    panel.grid.major.y = element_blank()
    , legend.position = "bottom"
    , panel.background = element_rect(fill = "white", colour = "white"
                                      , linetype = "solid", size = 0.5)
    , plot.background = element_rect(fill = "white", colour = "white"
                                      , linetype = "solid", size = 0.5)
  )
  
```



## Spatial 
The two maps below give an overview of the spatial representation of survey. 
The map on the left shows how the relative participation of the population below the Low Income Measure is spatially distributed in the Island of Montreal according to the 2021 Census. 
It seems clear that this group, which constitutes part of the target audience of the fare-free policy, are spatially concentrated on the eastern and northern parts of the island.
The map on the right complements the former, showing the under and over-representation of the survey against the population over 50 years old according to the census.
The survey's over-representation appears to be located on the regions that concentrate groups from low-income households, while under-representation occurs on less-populated and regions with low participation of the equity deserving groups from an income's perspective.


```{r, fig.align="center", fig.pos="H", fig.cap=c("Population in LIM (Census)", "Under/over-representation ratio of survey respondents vs. population over 50")}
#| label: map-1-under-over-fsa
#| out-width: 100%
#| fig-format: pdf
#| fig-asp: 1
#| layout-ncol: 2

# quarto figures
# https://r4ds.hadley.nz/quarto.html
# plot scaling
# https://quarto.org/docs/reference/cells/cells-knitr.html
# multiple plots and captions
# https://stackoverflow.com/a/41231696

# fig-cap: "Under/over-representation: Ratio of the proportions of survey respondents vs. the population over 50 in each FSA (left)"

tm_shape(fsa_ct_grouped) +
  tm_polygons(
    col = "prop_tot_in_lim"
    , style = "jenks"
    , palette = "YlGnBu"
    , border.alpha = 0.5
    , alpha = 0.95
    , title = "Proportion of Residents in LIM"
  ) + 
  tm_layout(
    legend.width = 2
    # , main.title = "Ratio of the proportions of survey respondents vs. the population over 50 in each CT"
    # , main.title.position = "center"
    # , main.title.size = 1.05
    , legend.title.size = 1.5
    , legend.text.size = 1
    , fontfamily = "roboto"
  ) +
  tm_compass(color.dark = "grey30", text.color = "grey30") +
  tm_scale_bar(
    breaks = c(0,2)
    , color.dark = "grey30"
    , text.color = "grey30"
    , position = "left"
    )

tm_shape(montreal_fsa) + 
  tm_polygons(
    col = "under_over"
    , breaks = c(0,0.5, 0.99, 1.01, 2, Inf)
    , palette = "RdBu"
    , border.alpha = 0.5
    , alpha = 0.95
    , labels = c("0.00-0.50: Survey underrepresents","0.50-0.99", '0.99-1.01', '1.01-2.00', '2.00 or more: Survey overrepresents')
    , title = "Ratio: Survey/(Census)"
    ) + 
  # tm_text(
  #   text = "label_survey"
  #   , size = 0.3
  #   # , col = "white"
  #   ) + 
  # tm_shape(montreal_fsa) +
  # tm_text(
  #     text = "label_census"
  #     , size = 0.3
  #     , ymod = -0.25
  #     # , col = "black"
  # ) +
  tm_add_legend(
    type = "text"
  ) +
  tm_layout(
    legend.width = 2
    # , main.title = "Ratio of the proportions of survey respondents vs. the population over 50 in each CT"
    # , main.title.position = "center"
    # , main.title.size = 1.05
    , legend.title.size = 1.5
    , legend.text.size = 1
    , fontfamily = "roboto"
  ) +
  tm_compass(color.dark = "grey30", text.color = "grey30") +
  tm_scale_bar(breaks = c(0,2), color.dark = "grey30", text.color = "grey30"
               , position = "left")

# tmap_arrange(tm_under_over_fsa, tm_under_over_ct)
```



# Descriptive analysis

Below, we get some basic information on who took the survey and what are some of the results related to their travel behavior.

## Who took the survey?

```{r, fig.align="center", fig.pos="H"}
#| echo: false
#| out-width: 100%
#| fig-format: pdf
#| fig-asp: 0.7
#| fig-width: 7.5
survey_filter_cd %>% select(
  visible_minority
  , gender
  , age_groups_control_treat
  , age_groups_5
  , lone_household
  , educ_has_postsec
  , employed
  , unemployed
  , employment
  , immigrant
  , any_mobility_limitation
  , any_functional_limitation
  , in_lim
  , has_vehicle_household
) %>% 
  rename(
    "Visible minority" = visible_minority
    , "Gender" = gender
    , 'Control and treatment' = age_groups_control_treat
    , "Age groups" = age_groups_5
    , "Lone household" = lone_household
    , "Has post-education" = educ_has_postsec
    , "Employed" = employed
    , "Unemployed" = unemployed
    , "Employment" = employment
    , "Immigrant" = immigrant
    , "Any mobility limitation" = any_mobility_limitation
    , "Any functional limitation" = any_functional_limitation
    , "In LIM" = in_lim
    , "Has Vehicle in Household" = has_vehicle_household
  ) %>% 
  mutate(
    Gender = fct_recode(Gender, Female = "female", Male = "male", Other = "other")
    , `Age groups` = fct_recode(`Age groups`, `Age 65 and over` = "age_65_over"
                              , `Age 60-64` = "age_60_64"
                              , `Age 55-59` = "age_55_59"
                              , `Age 50-54` = "age_50_54")
  ) %>% 
DataExplorer::plot_bar(
  data = .
  , ggtheme = theme(
    panel.background = element_rect(fill = "white", colour = "white"
                                      , linetype = "solid", size = 0.5)
    , plot.background = element_rect(fill = "white", colour = "white"
                                      , linetype = "solid", size = 0.5)
  )
  , nrow = 2L
  , ncol = 2L
) 
```


```{r}
#| tbl-cap: "Descriptive statistics of categorical variables"
#| out-width: 100%
survey_filter_cd %>% select(
  visible_minority
  , gender
  , age_groups_control_treat
  , age_groups_5
  , lone_household
  , educ_has_postsec
  , employed
  , unemployed
  , employment
  , immigrant
  , any_mobility_limitation
  , any_functional_limitation
  , in_lim
  , has_vehicle_household
) %>% 
  rename(
    "Visible minority" = visible_minority
    , "Gender" = gender
    , 'Control and treatment' = age_groups_control_treat
    , "Age groups" = age_groups_5
    , "Lone household" = lone_household
    , "Has post-education" = educ_has_postsec
    , "Employed" = employed
    , "Unemployed" = unemployed
    , "Employment" = employment
    , "Immigrant" = immigrant
    , "Any mobility limitation" = any_mobility_limitation
    , "Any functional limitation" = any_functional_limitation
    , "In LIM" = in_lim
    , "Has Vehicle in Household" = has_vehicle_household
  ) %>% 
  mutate(
    Gender = fct_recode(Gender, Female = "female", Male = "male", Other = "other")
    , `Age groups` = fct_recode(`Age groups`, `Age 65 and over` = "age_65_over"
                              , `Age 60-64` = "age_60_64"
                              , `Age 55-59` = "age_55_59"
                              , `Age 50-54` = "age_50_54")
  ) %>% modelsummary::datasummary_skim(type = "categorical")
```


## What is their travel behavior

